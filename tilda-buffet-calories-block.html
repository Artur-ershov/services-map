<!--
  МОДУЛЬ: КБЖУ + "Съел" для Буфета, Бизнес-завтрака и Заказа пиццы
  Страница: https://zabota.croc.ru/eda

  КАК ДОБАВИТЬ В TILDA:
  1. Добавьте блок T123 (HTML-код) на странице /eda.
  2. Разместите блок ПОСЛЕ блока с каталогом Tilda Store (Буфет / Бизнес-завтрак / Пицца).
  3. Вставьте весь этот код в блок.
  4. На странице должна быть панель дневника калорий (#diary-panel с total-kcal и т.д.).

  Модуль:
  - использует КБЖУ из API Tilda Store (если есть), иначе — локальный маппинг по PDF;
  - находит карточки Буфета, Бизнес-завтрака и Пиццы;
  - выводит КБЖУ и кнопку "+ Съел";
  - интегрируется с дневником (eda / глобальные функции).
-->
<div id="eda-buffet-calories-root" style="display:none;"></div>
<style>
  .eda-buffet-kbju { font-size: 12px; color: #555; background: #f9f9f9; padding: 8px 10px; border-radius: 6px; margin-top: 8px; }
  .eda-buffet-kbju span { display: block; margin-bottom: 6px; }
  .eda-buffet-syel { width: 100%; margin-top: 8px; padding: 10px; border: none; border-radius: 6px; background: #222; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
  .eda-buffet-syel:hover { background: #444; }
  .eda-buffet-syel:active { transform: scale(0.98); }
  .eda-buffet-syel.done { background: #4CAF50; }
</style>
<script>
(function() {
  'use strict';

  function normalize(s) {
    if (!s) return '';
    return s.trim().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\sа-яё]/gi,'');
  }

  var N = {
    "Каша из киноа на кокосовом молоке с сахаром, фруктами и орехами":[199,5,12,17],
    "Блинчики с мясом":[192,11,6,23],"Блинчики c мясом":[192,11,6,23],
    "Блинчики с творогом":[197,10,8,21],"Блинчики c творогом":[197,10,8,21],
    "Блинчики с клубнично сливочной начинкой и ягодным соусом":[429,10,21,50],
    "Сырники из творога со свежими фруктами и муссом из сметаны":[478,30,26,30],
    "Салат фруктовый с орехами":[113,2,4,18],"Хрустящая гранола":[474,7,22,59],
    "Скрембл с помидорами, авокадо и миксом салатных листьев":[159,12,11,4],
    "Яичница с колбасой из индейки, беконом и белой фасолью":[199,16,12,6],
    "Шакшука с овощами":[85,5,5,4],
    "Омлет конвертик фаршированный овощами, ветчиной и сыром":[97,4,3,13],
    "Тост с яйцом пашот, семгой и австралийским соусом":[170,10,1,5],
    "Брускетта с ростбифом из вырезки с вялеными томатами и рукколой":[141,10,2,21],
    "Цезарь с тигровыми":[168,12,8,11],"Цезарь с тигровыми креветками":[168,12,8,11],
    "Цезарь с куриным филе":[237,7,22,2],
    "Греческий из свежих овощей Холодные закуски":[189,4,18,3],"Греческий из свежих овощей":[189,4,18,3],
    "Салат с авокадо":[188,8,16,1.9],"Салат с авокадо и тигровыми креветками":[188,8,16,1.9],
    "Салат зеленый":[54,2,4,2],
    "Борщ украинский с мясом*":[429,10,21,50],
    "Бульон куриный меню Гарниры":[116,10,2,15],"Бульон куриный с перепелиными яйцами*":[116,10,2,15],
    "Овощная тарелка":[27,1,0,5],"Семга с маслом и лимоном":[142,23,10,0],
    "Маслины/оливки в ассортименте Первые блюда":[175,2,16,5],"Маслины/оливки":[175,2,16,5],
    "Картофельное пюре":[116,3,4,17],
    "Каша гречневая Вторые блюда":[101,4,1,19],"Каша гречневая":[101,4,1,19],
    "Брокколи зелень в ассортименте":[31,3,0,4],"Брокколи":[31,3,0,4],
    "Смесь рисов":[346,8,2,77],
    "Овощи гриль/соте":[55,2,1,9],"Овощи гриль/соте на ароматном оливковом масле":[55,2,1,9],
    "Шампиньоны жаренные":[37,4,2,1],"Шампиньоны жаренные с луком":[37,4,2,1],
    "Стейк из семги":[219,20,15,0],"Сибас на гриле с лимоном":[101,17,9,0],
    "Золотистый дорадо с лимоном на ароматном оливковом масле":[291,45,13,1],"Золотистый дорадо с лимоном":[291,45,13,1],
    "Язык говяжий отварной":[231,24,15,3],
    "помидоры, тимьян, розмарин, масло оливковое, Язык говяжий отварной (добавка к гарниру)":[231,24,15,3],
    "Вырезка говяжья cy-вид":[137,23,5,0],
    "Куриные окорочка cу-вид/ отварные return":[158,17,10,0],"Куриные окорочка cу-вид/ отварные":[158,17,10,0],
    "Филе индейки су-вид/отварное":[130,25,1,0],
    "Бефстроганов из говядины Напитки":[193,17,11,6],"Бефстроганов из говядины":[193,17,11,6],
    "Паста Карбонара":[208,7,12,18],
    "Паста с креветками":[139,7,4,16],"Паста с креветками и сливочным соусом":[139,7,4,16],
    "Апельсиновый сок":[90,1,0,20],"Яблочный сок (200мл)":[90,0,0,22],
    "Морковный сок":[50,1,0,11],"Морковный сок (200мл)":[50,1,0,11],
    "Марковно-яблочный сок (200мл)":[70,1,0,16],
    "Черный чай":[0,0,0,0],"Черный чай (200мл)":[0,0,0,0],
    "Зеленый чай":[0,0,0,0],"Зеленый чай (200мл)":[0,0,0,0],
    "Чиз Карбонара":[2050,92,88,210],"Четыре сыра":[1980,95,85,200],
    "Пепперони":[1920,88,82,215],"Баварская мясная":[2150,98,95,205]
  };

  function findNutrition(title) {
    if (!title) return null;
    var u = normalize(title);
    if (N[title]) return N[title];
    for (var k in N) {
      var v = normalize(k);
      if (u.indexOf(v) !== -1 || v.indexOf(u) !== -1) return N[k];
    }
    if (u.indexOf('цезарь') !== -1 && u.indexOf('тигров') !== -1) return N["Цезарь с тигровыми"];
    if (u.indexOf('цезарь') !== -1 && u.indexOf('курин') !== -1) return N["Цезарь с куриным филе"];
    if (u.indexOf('греческ') !== -1 && u.indexOf('овощ') !== -1) return N["Греческий из свежих овощей"];
    if (u.indexOf('салат') !== -1 && u.indexOf('авокадо') !== -1) return N["Салат с авокадо"];
    if (u.indexOf('салат') !== -1 && u.indexOf('зелен') !== -1) return N["Салат зеленый"];
    if (u.indexOf('борщ') !== -1) return N["Борщ украинский с мясом*"];
    if (u.indexOf('бульон') !== -1 && u.indexOf('курин') !== -1) return N["Бульон куриный меню Гарниры"];
    if (u.indexOf('овощн') !== -1 && u.indexOf('тарел') !== -1) return N["Овощная тарелка"];
    if (u.indexOf('семга') !== -1 && u.indexOf('масл') !== -1) return N["Семга с маслом и лимоном"];
    if (u.indexOf('маслин') !== -1 || u.indexOf('оливк') !== -1) return N["Маслины/оливки"];
    if (u.indexOf('картофел') !== -1 && u.indexOf('пюре') !== -1) return N["Картофельное пюре"];
    if (u.indexOf('каша') !== -1 && u.indexOf('гречнев') !== -1) return N["Каша гречневая"];
    if (u.indexOf('брокколи') !== -1) return N["Брокколи"];
    if (u.indexOf('смесь') !== -1 && u.indexOf('рис') !== -1) return N["Смесь рисов"];
    if (u.indexOf('овощ') !== -1 && (u.indexOf('гриль') !== -1 || u.indexOf('соте') !== -1)) return N["Овощи гриль/соте"];
    if (u.indexOf('шампиньон') !== -1) return N["Шампиньоны жаренные"];
    if (u.indexOf('стейк') !== -1 && u.indexOf('семг') !== -1) return N["Стейк из семги"];
    if (u.indexOf('сибас') !== -1) return N["Сибас на гриле с лимоном"];
    if (u.indexOf('дорадо') !== -1) return N["Золотистый дорадо с лимоном"];
    if (u.indexOf('язык') !== -1 && u.indexOf('говяж') !== -1) return N["Язык говяжий отварной"];
    if (u.indexOf('вырезка') !== -1 && u.indexOf('говяж') !== -1) return N["Вырезка говяжья cy-вид"];
    if (u.indexOf('окорочк') !== -1 && u.indexOf('курин') !== -1) return N["Куриные окорочка cу-вид/ отварные"];
    if (u.indexOf('филе') !== -1 && u.indexOf('индейк') !== -1) return N["Филе индейки су-вид/отварное"];
    if (u.indexOf('бефстроганов') !== -1) return N["Бефстроганов из говядины"];
    if (u.indexOf('паста') !== -1 && u.indexOf('карбонар') !== -1) return N["Паста Карбонара"];
    if (u.indexOf('паста') !== -1 && u.indexOf('креветк') !== -1) return N["Паста с креветками"];
    if (u.indexOf('апельсинов') !== -1 && u.indexOf('сок') !== -1) return N["Апельсиновый сок"];
    if (u.indexOf('яблочн') !== -1 && u.indexOf('сок') !== -1) return N["Яблочный сок (200мл)"];
    if (u.indexOf('морковн') !== -1 && u.indexOf('сок') !== -1) return N["Морковный сок"];
    if (u.indexOf('марковн') !== -1 && u.indexOf('яблочн') !== -1) return N["Марковно-яблочный сок (200мл)"];
    if (u.indexOf('черн') !== -1 && u.indexOf('чай') !== -1) return N["Черный чай"];
    if (u.indexOf('зелен') !== -1 && u.indexOf('чай') !== -1) return N["Зеленый чай"];
    if (u.indexOf('чиз') !== -1 && u.indexOf('карбонар') !== -1) return N["Чиз Карбонара"];
    if (u.indexOf('четыре') !== -1 && u.indexOf('сыр') !== -1) return N["Четыре сыра"];
    if (u.indexOf('пепперони') !== -1) return N["Пепперони"];
    if (u.indexOf('баварск') !== -1 && u.indexOf('мясн') !== -1) return N["Баварская мясная"];
    return null;
  }

  var cache = null;
  var loading = false;

  function loadAPI() {
    if (cache || loading) return Promise.resolve(cache);
    
    loading = true;
    return fetch('https://store.tildaapi.com/api/getproductslist/?storepartuid=444717808081&recid=1738672781&getparts=true&getoptions=true&slice=1&size=100')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data && data.products && Array.isArray(data.products)) {
          cache = { byTitle: {}, byUid: {}, byExternalId: {} };
          
          data.products.forEach(function(p) {
            if (!p.title || !p.characteristics) return;
            
            var n = [0, 0, 0, 0];
            p.characteristics.forEach(function(c) {
              if (c.title === 'Ккал') n[0] = parseInt(c.value) || 0;
              else if (c.title === 'Белки') n[1] = parseFloat(c.value) || 0;
              else if (c.title === 'Жиры') n[2] = parseFloat(c.value) || 0;
              else if (c.title === 'Углеводы') n[3] = parseFloat(c.value) || 0;
            });
            
            cache.byTitle[p.title] = n;
            cache.byTitle[normalize(p.title)] = n;
            if (p.uid) {
              cache.byUid[p.uid] = n;
              cache.byUid[p.uid.toString()] = n;
            }
            if (p.externalid) cache.byExternalId[p.externalid] = n;
          });
        }
        loading = false;
        window.tildaProductsCache = cache;
        return cache;
      })
      .catch(function(err) {
        console.warn('Не удалось загрузить данные из Tilda API:', err);
        loading = false;
        return null;
      });
  }

  function getNutrition(el, name) {
    var card = el ? (el.closest('[class*="card"], [class*="product"], [class*="item"]') || el.closest('div') && el.closest('div').parentElement) : null;
    var n = (name || (el && (el.textContent || '').trim()) || '').trim();
    
    if (cache) {
      if (cache.byTitle[n]) return cache.byTitle[n];
      if (cache.byTitle[normalize(n)]) return cache.byTitle[normalize(n)];
      if (card) {
        var uid = card.getAttribute('data-product-uid') || card.getAttribute('data-uid') || (card.querySelector('[data-product-uid]') && card.querySelector('[data-product-uid]').getAttribute('data-product-uid'));
        if (uid && cache.byUid[uid]) return cache.byUid[uid];
        var extId = card.getAttribute('data-external-id') || card.getAttribute('data-externalid');
        if (extId && cache.byExternalId[extId]) return cache.byExternalId[extId];
      }
    }
    
    var fallback = findNutrition(n);
    if (fallback) return fallback;
    return null;
  }

  function addToDiary(name, nutrition, el, category) {
    var cat = category || 'Буфет';
    if (typeof window.addBuffetItemToDiary === 'function') {
      window.addBuffetItemToDiary(name, el);
      return;
    }
    
    if (!window.dailyLog) window.dailyLog = [];
    if (!window.buffetItemCounter) window.buffetItemCounter = 10000;
    
    window.dailyLog.push({
      id: window.buffetItemCounter++,
      name: name,
      category: cat,
      type: cat,
      weight: '1 порция',
      nutri: { kcal: nutrition[0], prot: nutrition[1], fat: nutrition[2], carb: nutrition[3] },
      tags: { protein: nutrition[1] > 20, fiber: false, lactose: false, gf: false, vegan: false },
      allergies: '',
      source: cat === 'Пицца' ? 'pizza' : 'buffet'
    });
    
    if (typeof window.saveDiary === 'function') window.saveDiary();
    if (typeof window.updateDiaryUI === 'function') window.updateDiaryUI();
    
    var pan = document.getElementById('diary-panel');
    if (pan) pan.style.display = 'flex';
  }

  function inject() {
    document.querySelectorAll('.js-store-prod-name, .js-product-name').forEach(function(titleEl) {
      var card = titleEl.closest('[class*="t-store__card"],[class*="t-store__prod"]') ||
                 titleEl.closest('[class*="card"],[class*="product"],[class*="item"]') ||
                 titleEl.closest('.t-store__card__textwrapper') ||
                 (titleEl.closest('div') && titleEl.closest('div').parentElement);
      if (!card) return;
      
      var p = card;
      var section = '';
      for (var i = 0; i < 12 && p; i++) {
        var t = (p.textContent || '');
        if (t.indexOf('Пицца') !== -1 || t.indexOf('Заказ пиццы') !== -1 || t.indexOf('римской пиццы') !== -1) {
          section = 'Пицца';
          break;
        }
        if (t.indexOf('Бизнес-завтрак') !== -1) {
          section = 'Бизнес-завтрак';
          break;
        }
        if (t.indexOf('Буфет') !== -1) {
          section = 'Буфет';
          break;
        }
        p = p.parentElement;
      }
      if (!section) return;
      if (card.getAttribute('data-eda-buffet-done')) return;
      if (card.querySelector('.eda-buffet-kbju')) return;
      
      card.setAttribute('data-eda-buffet-done', '1');
      
      var name = (titleEl.textContent || '').trim();
      var nutrition = getNutrition(titleEl, name);
      var sum = nutrition ? (nutrition[0] + nutrition[1] + nutrition[2] + nutrition[3]) : 0;
      if (!nutrition || sum === 0) return;
      
      var wrap = document.createElement('div');
      wrap.className = 'eda-buffet-kbju';
      wrap.innerHTML = '<span>' + nutrition[0] + ' ккал · Б ' + nutrition[1] + ' · Ж ' + nutrition[2] + ' · У ' + nutrition[3] + '</span>';
      
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'eda-buffet-syel';
      btn.textContent = '+ Съел';
      var cat = section;
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        addToDiary(name, nutrition, titleEl, cat);
        var orig = btn.textContent;
        btn.textContent = '✓ Добавлено';
        btn.classList.add('done');
        setTimeout(function() {
          btn.textContent = orig;
          btn.classList.remove('done');
        }, 1000);
        return false;
      };
      
      wrap.appendChild(btn);
      card.appendChild(wrap);
    });
  }

  function init() {
    loadAPI().then(function() {
      inject();
      setTimeout(inject, 300);
    });
    
    inject();
    setTimeout(inject, 800);
    setTimeout(inject, 2000);
    
    var lastInject = 0;
    var mo = typeof MutationObserver !== 'undefined' ? new MutationObserver(function() {
      var now = Date.now();
      if (now - lastInject < 400) return;
      lastInject = now;
      setTimeout(inject, 300);
    }) : null;
    if (mo && document.body) mo.observe(document.body, { childList: true, subtree: true });
    
    document.addEventListener('click', function(e) {
      if ((e.target.textContent || '').indexOf('Загрузить еще') !== -1) {
        setTimeout(inject, 1500);
      }
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
