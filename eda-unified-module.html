<!--
  –ï–î–ò–ù–´–ô –ú–û–î–£–õ–¨: –°—Ç–æ–ª–æ–≤–∞—è + –ë—É—Ñ–µ—Ç
  –°—Ç—Ä–∞–Ω–∏—Ü–∞: https://zabota.croc.ru/eda

  –ö–ê–ö –î–û–ë–ê–í–ò–¢–¨ –í TILDA:
  1. –î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ T123 (HTML-–∫–æ–¥) –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /eda.
  2. –í—Å—Ç–∞–≤—å—Ç–µ –≤–µ—Å—å —ç—Ç–æ—Ç –∫–æ–¥ –≤ –±–ª–æ–∫.
  3. –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–æ–ª–æ–≤–æ–π –∏ –¥–æ–±–∞–≤–∏—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É—Ñ–µ—Ç–∞.

  –ú–æ–¥—É–ª—å –≤–∫–ª—é—á–∞–µ—Ç:
  - –°—Ç–æ–ª–æ–≤–∞—è: –º–µ–Ω—é –∏–∑ Google Sheets, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥, —Å–ø–∏—Å–æ–∫ –±–ª—é–¥
  - –ë—É—Ñ–µ—Ç: –ö–ë–ñ–£ –∏–∑ API Tilda Store, –∫–Ω–æ–ø–∫–∞ "+ –°—ä–µ–ª"
  - –û–±—â–∏–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è —Å –ø–∞–Ω–µ–ª—å—é –≤–Ω–∏–∑—É
-->
<div id="eda-unified-module" style="display:none;"></div>
<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–æ–ª–æ–≤–æ–π */
  #menu-app { font-family: 'Croc', sans-serif; max-width: 1200px; margin: 0 auto; padding: 40px; padding-bottom: 100px; color: #333; }
  .menu-header { text-align: center; margin-bottom: 30px; }
  #current-date-title {font-size: var(--uc-typo-fontsize-t95jYC4tS2qc, 54px); padding-bottom: 10px; font-weight: var(--uc-typo-fontweight-t95jYC4tS2qc, 800); font-variation-settings: 'wdth' 120;}
  .current-info { color: #888; font-size: 14px; margin-top: 5px; }
  .menu-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; justify-content: center; align-items: center; }
  .meal-tabs { display: flex; background: #f0f0f0; border-radius: 8px; padding: 4px; }
  .meal-tab { padding: 10px 20px; cursor: pointer; border-radius: 6px; border: none; background: transparent; font-weight: 600; transition: 0.2s; }
  .meal-tab.active { background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .filters-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .filter-label { display: flex; align-items: center; cursor: pointer; font-size: 13px; user-select: none; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; transition: 0.2s; }
  .filter-label:hover { background-color: #f5f5f5; border-color: #bbb; }
  .filter-label input { margin-right: 8px; }
  .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .dish-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
  .dish-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
  .dish-category { font-size: 10px; text-transform: uppercase; color: #999; letter-spacing: 1px; margin-bottom: 8px; font-weight: 700; }
  .dish-name { font-size: 16px; font-weight: 600; margin-bottom: 10px; flex-grow: 1; line-height: 1.4; }
  .dish-meta { font-size: 13px; color: #666; margin-bottom: 8px; }
  .dish-price { font-size: 18px; font-weight: 700; color: #222; margin-bottom: 8px; }
  .dish-composition { font-size: 12px; color: #666; margin-bottom: 8px; line-height: 1.4; font-style: italic; }
  .dish-nutrition { font-size: 12px; color: #555; background: #EBEFF3; padding: 8px; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; }
  .dish-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: auto; }
  .tag { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: #eee; color: #555; }
  .tag.vegan { background: #e8f5e9; color: #2e7d32; }
  .tag.gf { background: #fff3e0; color: #ef6c00; }
  .tag.lactose { background: #e3f2fd; color: #1565c0; }
  .tag.protein { background: #fce4ec; color: #c2185b; }
  .tag.fiber { background: #f1f8e9; color: #558b2f; }
  .tag.ot-shefa { background: #fff9c4; color: #f57f17; font-weight: 600; }
  .tag.stantsiya { background: #e8eaf6; color: #3949ab; font-weight: 600; }
  .tag.harvard { background: #f3e5f5; color: #7b1fa2; font-weight: 600; }
  .tag.allergy { background: #ffebee; color: #c62828; }
  .add-btn { margin-top: 15px; padding: 10px; border: none; border-radius: 6px; background-color: #222; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; }
  .add-btn:hover { background-color: #444; }
  .add-btn:active { transform: scale(0.98); }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –±—É—Ñ–µ—Ç–∞ */
  .eda-buffet-kbju { display: inline-block; font-size: 14px; color: #555; background: #EBEFF3; padding: 8px 10px; border-radius: 6px; margin-top: 16px; }
  .eda-buffet-kbju span { display: block; margin-bottom: 6px; }
  .eda-buffet-syel {margin-right: 5px; margin-top: 8px; padding: 10px; border: none; border-radius: 6px; background: #222; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
  .eda-buffet-syel:hover { background: #444; }
  .eda-buffet-syel:active { transform: scale(0.98); }
  .eda-buffet-syel.done { background: #4CAF50; }
  
  /* –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è */
  .nutrition-diary { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #ddd; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 15px 20px; z-index: 9999; display: flex; justify-content: center; align-items: center; gap: 20px; font-family: 'Croc', sans-serif; }
  .diary-content { max-width: 1000px; width: 100%; display: flex; justify-content: space-between; align-items: center; font-family: 'Croc', sans-serif; }
  .diary-stats { display: flex; gap: 20px; font-size: 14px; font-family: 'Croc', sans-serif; }
  .stat-item { display: flex; flex-direction: column; align-items: center; font-family: 'Croc', sans-serif; }
  .stat-val { font-weight: bold; font-size: 18px; color: #222; font-family: 'Croc', sans-serif; }
  .stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-family: 'Croc', sans-serif; }
  .diary-user { font-size: 13px; color: #666; text-align: right; font-family: 'Croc', sans-serif; display: flex; gap: 10px; align-items: center; }
  .reset-btn { font-size: 13px; color: #fff; background: #dc3545; cursor: pointer; padding: 8px 16px; border-radius: 6px; border: none; font-family: 'Croc', sans-serif; font-weight: 600; transition: 0.2s; }
  .reset-btn:hover { background: #c82333; }
  .diary-list-btn { font-size: 13px; color: #fff; background: #222; cursor: pointer; padding: 8px 16px; border-radius: 6px; border: none; font-family: 'Croc', sans-serif; font-weight: 600; transition: 0.2s; text-decoration: none; }
  .diary-list-btn:hover { background: #444; }
  
  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø–∏—Å–∫–∞ –±–ª—é–¥ */
  .diary-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
  .diary-modal.active { display: flex; }
  .diary-modal-content { background: #fff; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
  .diary-modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 1; font-family: 'Croc', sans-serif; }
  .diary-modal-title { font-size: 20px; font-weight: 600; margin: 0; font-family: 'Croc', sans-serif; }
  .diary-modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
  .diary-modal-close:hover { background: #f5f5f5; color: #222; }
  .diary-modal-body { padding: 20px; font-family: 'Croc', sans-serif; }
  .diary-list-empty { text-align: center; padding: 40px; color: #999; font-family: 'Croc', sans-serif; }
  .diary-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; font-family: 'Croc', sans-serif; }
  .diary-list-item:hover { background: #EBEFF3; }
  .diary-list-item:last-child { border-bottom: none; }
  .diary-list-item-info { flex: 1; min-width: 0; font-family: 'Croc', sans-serif; }
  .diary-list-item-name { font-size: 16px; font-weight: 600; margin-bottom: 5px; color: #222; font-family: 'Croc', sans-serif; }
  .diary-list-item-details { font-size: 13px; color: #666; display: flex; gap: 15px; flex-wrap: wrap; font-family: 'Croc', sans-serif; }
  .diary-list-item-nutrition { font-size: 12px; color: #888; font-family: 'Croc', sans-serif; }
  .diary-list-item-actions { display: flex; align-items: center; gap: 10px; }
  .diary-list-item-kcal { font-size: 16px; font-weight: 600; color: #222; min-width: 60px; text-align: right; font-family: 'Croc', sans-serif; }
  .diary-list-item-remove { background: none; border: none; cursor: pointer; color: #999; font-size: 18px; padding: 5px; border-radius: 4px; transition: 0.2s; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
  .diary-list-item-remove:hover { background: #ffebee; color: #c62828; }
  .diary-list-total { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-top: 2px solid #222; margin-top: 10px; font-weight: 600; font-size: 18px; background: #f9f9f9; font-family: 'Croc', sans-serif; }
  .diary-list-total-label { color: #222; }
  .diary-list-total-value { color: #222; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
(function() {
  'use strict';

  // === –ù–ê–°–¢–†–û–ô–ö–ò ===
  var GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnzxGpaq3VFRj6LxXkelyneZ68-CnoHtIJlij1FqT3ux9hyoGd-Li5IcxqebTItPiQISCsZexzwG6S/pub?output=csv";
  var CYCLE_START_DATE = new Date("2025-11-24");
  var TILDA_API_URL = 'https://store.tildaapi.com/api/getproductslist/?storepartuid=444717808081&recid=1738672781&getparts=true&getoptions=true&slice=1&size=100';

  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
  var allMenuData = [];
  var currentMealType = "–ó–∞–≤—Ç—Ä–∞–∫";
  var activeFilters = { vegan: false, gf: false, lactose: false, protein: false, fiber: false };
  var activeCategories = [];
  var showHarvard = false;
  var userEmail = "guest";
  var dailyLog = [];
  var buffetItemCounter = 10000;
  var tildaCache = null;
  var tildaLoading = false;

  // === –£–¢–ò–õ–ò–¢–´ ===
  function normalize(s) {
    if (!s) return '';
    return s.trim().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s–∞-—è—ë]/gi,'');
  }

  function getTodayKey() {
    var today = new Date().toISOString().split('T')[0];
    return 'diary_' + userEmail + '_' + today;
  }

  function getRealWeekNumber(d) {
    var current = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    var start = new Date(Date.UTC(CYCLE_START_DATE.getFullYear(), CYCLE_START_DATE.getMonth(), CYCLE_START_DATE.getDate()));
    var dayDiff = Math.floor((current - start) / (24 * 60 * 60 * 1000));
    if (dayDiff < 0) return 1;
    return (Math.floor(dayDiff / 7) % 4) + 1;
  }

  function getRealDayName() {
    var days = ["–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];
    return days[new Date().getDay()];
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
  function loadTildaAPI() {
    if (tildaCache || tildaLoading) return Promise.resolve(tildaCache);
    
    tildaLoading = true;
    return fetch(TILDA_API_URL)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data && data.products && Array.isArray(data.products)) {
          tildaCache = { byTitle: {}, byUid: {}, byExternalId: {} };
          
          data.products.forEach(function(p) {
            if (!p.title || !p.characteristics) return;
            
            var n = [0, 0, 0, 0];
            p.characteristics.forEach(function(c) {
              if (c.title === '–ö–∫–∞–ª') n[0] = parseInt(c.value) || 0;
              else if (c.title === '–ë–µ–ª–∫–∏') n[1] = parseFloat(c.value) || 0;
              else if (c.title === '–ñ–∏—Ä—ã') n[2] = parseFloat(c.value) || 0;
              else if (c.title === '–£–≥–ª–µ–≤–æ–¥—ã') n[3] = parseFloat(c.value) || 0;
            });
            
            tildaCache.byTitle[p.title] = n;
            tildaCache.byTitle[normalize(p.title)] = n;
            if (p.uid) {
              tildaCache.byUid[p.uid] = n;
              tildaCache.byUid[p.uid.toString()] = n;
            }
            if (p.externalid) tildaCache.byExternalId[p.externalid] = n;
          });
        }
        tildaLoading = false;
        window.tildaProductsCache = tildaCache;
        return tildaCache;
      })
      .catch(function(err) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Tilda API:', err);
        tildaLoading = false;
        return null;
      });
  }

  function getBuffetNutrition(el) {
    if (!el || !tildaCache) return null;
    
    var card = el.closest('[class*="card"], [class*="product"], [class*="item"]') || el.closest('div').parentElement;
    if (!card) return null;
    
    var name = (el.textContent || '').trim();
    var normName = normalize(name);
    
    if (tildaCache.byTitle[name]) return tildaCache.byTitle[name];
    if (tildaCache.byTitle[normName]) return tildaCache.byTitle[normName];
    
    var uid = card.getAttribute('data-product-uid') || card.getAttribute('data-uid') || 
              (card.querySelector('[data-product-uid]') ? card.querySelector('[data-product-uid]').getAttribute('data-product-uid') : null);
    if (uid && tildaCache.byUid[uid]) return tildaCache.byUid[uid];
    
    var extId = card.getAttribute('data-external-id') || card.getAttribute('data-externalid');
    if (extId && tildaCache.byExternalId[extId]) return tildaCache.byExternalId[extId];
    
    return null;
  }

  // === –î–ù–ï–í–ù–ò–ö ===
  function loadDiary() {
    var key = getTodayKey();
    var saved = localStorage.getItem(key);
    dailyLog = saved ? JSON.parse(saved) : [];
  }

  function saveDiary() {
    var key = getTodayKey();
    try {
      localStorage.setItem(key, JSON.stringify(dailyLog));
    } catch(e) {}
  }

  function updateDiaryUI() {
    var tot = { kcal: 0, prot: 0, fat: 0, carb: 0 };
    for (var i = 0; i < dailyLog.length; i++) {
      var x = dailyLog[i].nutri || {};
      tot.kcal += (x.kcal || 0);
      tot.prot += (x.prot || 0);
      tot.fat += (x.fat || 0);
      tot.carb += (x.carb || 0);
    }

    var k = document.getElementById('total-kcal');
    var p = document.getElementById('total-prot');
    var f = document.getElementById('total-fat');
    var c = document.getElementById('total-carb');
    
    if (k) k.textContent = Math.round(tot.kcal);
    if (p) p.textContent = tot.prot.toFixed(1);
    if (f) f.textContent = tot.fat.toFixed(1);
    if (c) c.textContent = tot.carb.toFixed(1);

    var panel = document.getElementById('diary-panel');
    if (panel) {
      panel.style.display = dailyLog.length > 0 ? 'flex' : 'none';
    }
    
    if (document.getElementById('diary-modal') && document.getElementById('diary-modal').classList.contains('active')) {
      renderDiaryList();
    }
  }

  function resetDiary() {
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —Ä–∞—Ü–∏–æ–Ω –∑–∞ —Å–µ–≥–æ–¥–Ω—è?")) {
      dailyLog = [];
      saveDiary();
      updateDiaryUI();
    }
  }

  // === –°–ü–ò–°–û–ö –ë–õ–Æ–î ===
  function openDiaryList() {
    var modal = document.getElementById('diary-modal');
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      renderDiaryList();
    }
  }

  function closeDiaryList() {
    var modal = document.getElementById('diary-modal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  function renderDiaryList() {
    var container = document.getElementById('diary-list-body');
    if (!container) return;
    
    if (dailyLog.length === 0) {
      container.innerHTML = '<div class="diary-list-empty">–°–ø–∏—Å–æ–∫ –±–ª—é–¥ –ø—É—Å—Ç</div>';
      return;
    }
    
    var html = '';
    var total = { kcal: 0, prot: 0, fat: 0, carb: 0 };
    
    for (var i = 0; i < dailyLog.length; i++) {
      var item = dailyLog[i];
      total.kcal += (item.nutri.kcal || 0);
      total.prot += (item.nutri.prot || 0);
      total.fat += (item.nutri.fat || 0);
      total.carb += (item.nutri.carb || 0);
      
      var nutritionParts = [];
      if (item.nutri.kcal > 0) nutritionParts.push(Math.round(item.nutri.kcal) + ' –∫–∫–∞–ª');
      if (item.nutri.prot > 0) nutritionParts.push('–ë: ' + item.nutri.prot.toFixed(1));
      if (item.nutri.fat > 0) nutritionParts.push('–ñ: ' + item.nutri.fat.toFixed(1));
      if (item.nutri.carb > 0) nutritionParts.push('–£: ' + item.nutri.carb.toFixed(1));
      
      html += '<div class="diary-list-item">' +
        '<div class="diary-list-item-info">' +
          '<div class="diary-list-item-name">' + item.name + '</div>' +
          '<div class="diary-list-item-details">' +
            (item.category ? '<span>' + item.category + '</span>' : '') +
            (item.weight ? '<span>–í–µ—Å: ' + item.weight + '</span>' : '') +
            (nutritionParts.length > 0 ? '<span class="diary-list-item-nutrition">' + nutritionParts.join(' ‚Ä¢ ') + '</span>' : '') +
          '</div>' +
        '</div>' +
        '<div class="diary-list-item-actions">' +
          '<div class="diary-list-item-kcal">' + (item.nutri.kcal > 0 ? Math.round(item.nutri.kcal) : '‚Äî') + '</div>' +
          '<button class="diary-list-item-remove" onclick="window.edaRemoveFromDiary(' + i + ')" aria-label="–£–¥–∞–ª–∏—Ç—å">√ó</button>' +
        '</div>' +
      '</div>';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É "–ò—Ç–æ–≥–æ"
    html += '<div class="diary-list-total">' +
      '<div class="diary-list-total-label">–ò—Ç–æ–≥–æ</div>' +
      '<div class="diary-list-total-value">' +
        Math.round(total.kcal) + ' –∫–∫–∞–ª ‚Ä¢ ' +
        '–ë: ' + total.prot.toFixed(1) + ' ‚Ä¢ ' +
        '–ñ: ' + total.fat.toFixed(1) + ' ‚Ä¢ ' +
        '–£: ' + total.carb.toFixed(1) +
      '</div>' +
    '</div>';
    
    container.innerHTML = html;
  }

  function removeFromDiary(index) {
    if (index >= 0 && index < dailyLog.length) {
      dailyLog.splice(index, 1);
      saveDiary();
      updateDiaryUI();
    }
  }

  // === –°–¢–û–õ–û–í–ê–Ø ===
  function addToDiary(id) {
    var dish = allMenuData.find(function(d) { return d.id === id; });
    if (dish) {
      dailyLog.push(dish);
      saveDiary();
      updateDiaryUI();
      
      var btn = document.getElementById('btn-' + id);
      if (btn) {
        var orig = btn.textContent;
        btn.textContent = '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ';
        btn.style.background = '#4CAF50';
        setTimeout(function() {
          btn.textContent = orig;
          btn.style.background = '#222';
        }, 1000);
      }
    }
  }

  function getCategoriesForMeal(meal) {
    if (meal === '–ó–∞–≤—Ç—Ä–∞–∫') {
      return ['–•–æ–ª–æ–¥–Ω—ã–µ –∑–∞–∫—É—Å–∫–∏', '–ì–æ—Ä—è—á–∏–µ –±–ª—é–¥–∞'];
    } else if (meal === '–û–±–µ–¥') {
      return ['–°–∞–ª–∞—Ç—ã', '–°—É–ø—ã', '–ì–∞—Ä–Ω–∏—Ä—ã', '–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞', '–ù–∞–ø–∏—Ç–∫–∏'];
    }
    return [];
  }

  function updateCategoryFilters() {
    var container = document.getElementById('category-filters');
    if (!container) return;
    
    var categories = getCategoriesForMeal(currentMealType);
    activeCategories = activeCategories.filter(function(cat) { return categories.indexOf(cat) !== -1; });
    
    var html = '';
    for (var i = 0; i < categories.length; i++) {
      var cat = categories[i];
      var isActive = activeCategories.indexOf(cat) !== -1;
      var escapedCat = cat.replace(/'/g, "\\'");
      html += '<label class="filter-label" style="background: ' + (isActive ? '#e3f2fd' : '#fff') + ';">' +
        '<input type="checkbox" ' + (isActive ? 'checked' : '') + ' onchange="window.edaToggleCategory(\'' + escapedCat + '\')"> ' + cat +
      '</label>';
    }
    container.innerHTML = html;
  }

  function toggleCategory(category) {
    var validCategories = ['–°–∞–ª–∞—Ç—ã', '–°—É–ø—ã', '–ì–∞—Ä–Ω–∏—Ä—ã', '–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞', '–ù–∞–ø–∏—Ç–∫–∏', '–•–æ–ª–æ–¥–Ω—ã–µ –∑–∞–∫—É—Å–∫–∏', '–ì–æ—Ä—è—á–∏–µ –±–ª—é–¥–∞'];
    var normalizedCategory = category.trim();
    
    if (validCategories.indexOf(normalizedCategory) === -1) return;
    
    var index = activeCategories.indexOf(normalizedCategory);
    if (index > -1) {
      activeCategories.splice(index, 1);
    } else {
      activeCategories.push(normalizedCategory);
    }
    updateCategoryFilters();
    renderMenu();
  }

  function toggleHarvard() {
    showHarvard = !showHarvard;
    renderMenu();
  }

  function setMealType(type) {
    if (type === '–ó–∞–≤—Ç—Ä–∞–∫' || type === '–û–±–µ–¥') {
      currentMealType = type;
    } else {
      currentMealType = '–ó–∞–≤—Ç—Ä–∞–∫';
    }
    var tabs = document.querySelectorAll('.meal-tab');
    for (var i = 0; i < tabs.length; i++) {
      var tabText = (tabs[i].textContent || '').trim();
      tabs[i].classList.toggle('active', tabText === type);
    }
    updateCategoryFilters();
    renderMenu();
  }

  function toggleFilter(key) {
    activeFilters[key] = !activeFilters[key];
    renderMenu();
  }

  function renderMenu() {
    var container = document.getElementById('menu-container');
    if (!container) return;
    
    var isDebug = document.getElementById('debug-mode');
    isDebug = isDebug ? isDebug.checked : false;
    
    var targetWeek = isDebug ? parseInt(document.getElementById('debug-week').value) : getRealWeekNumber(new Date());
    var targetDayName = isDebug ? document.getElementById('debug-day').value : getRealDayName();
    
    var validDays = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    targetDayName = targetDayName.trim();
    if (validDays.indexOf(targetDayName) === -1) {
      targetDayName = getRealDayName();
    }
    
    var normalizedMealType = (currentMealType === '–ó–∞–≤—Ç—Ä–∞–∫' || currentMealType === '–û–±–µ–¥') ? currentMealType : '–ó–∞–≤—Ç—Ä–∞–∫';
    
    var cycleInfo = document.getElementById('cycle-info');
    if (cycleInfo) cycleInfo.textContent = '–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: ' + targetDayName + ' | –ù–µ–¥–µ–ª—è —Ü–∏–∫–ª–∞: ' + targetWeek;

    var filtered = allMenuData.filter(function(item) {
      if (item.week !== targetWeek) return false;
      if (item.day.toLowerCase() !== targetDayName.toLowerCase()) return false;
      if (item.type !== normalizedMealType) return false;
      
      if (activeCategories.length > 0 && activeCategories.indexOf(item.category) === -1) {
        return false;
      }
      
      if (showHarvard) {
        if (!item.harvardPlate || item.harvardPlate.toUpperCase() !== 'TRUE') {
          return false;
        }
      }
      
      if (activeFilters.vegan && !item.tags.vegan) return false;
      if (activeFilters.gf && !item.tags.gf) return false;
      if (activeFilters.lactose && !item.tags.lactose) return false;
      if (activeFilters.protein && !item.tags.protein) return false;
      if (activeFilters.fiber && !item.tags.fiber) return false;
      return true;
    });

    if (filtered.length === 0) {
      container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">–í —ç—Ç–æ—Ç –¥–µ–Ω—å –º–µ–Ω—é –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
      return;
    }

    var html = '';
    for (var i = 0; i < filtered.length; i++) {
      var item = filtered[i];
      var tagsHtml = '';
      if (item.tags.vegan) tagsHtml += '<span class="tag vegan">–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ</span>';
      if (item.tags.gf) tagsHtml += '<span class="tag gf">–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞</span>';
      if (item.tags.lactose) tagsHtml += '<span class="tag lactose">–ë–µ–∑ –ª–∞–∫—Ç–æ–∑—ã</span>';
      if (item.tags.protein) tagsHtml += '<span class="tag protein">–ú–Ω–æ–≥–æ –±–µ–ª–∫–∞</span>';
      if (item.tags.fiber) tagsHtml += '<span class="tag fiber">–ú–Ω–æ–≥–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏</span>';
      if (item.otShefa) tagsHtml += '<span class="tag ot-shefa">–û—Ç –®–µ—Ñ–∞</span>';
      if (item.stantsiya) tagsHtml += '<span class="tag stantsiya">–°—Ç–∞–Ω—Ü–∏—è</span>';
      if (item.allergies) tagsHtml += '<span class="tag allergy">‚ö†Ô∏è ' + item.allergies + '</span>';
      if (item.harvardPlate && item.harvardPlate.toUpperCase() === 'TRUE') tagsHtml += '<span class="tag harvard">üçΩÔ∏è –ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∞—è —Ç–∞—Ä–µ–ª–∫–∞</span>';

      var hasNutrition = item.nutri.kcal > 0 || item.nutri.prot > 0 || item.nutri.fat > 0 || item.nutri.carb > 0;
      var nutritionHtml = hasNutrition ? 
        '<div class="dish-nutrition">' +
          '<span>' + (item.nutri.kcal > 0 ? Math.round(item.nutri.kcal) : 0) + ' –∫–∫–∞–ª</span>' +
          '<span>–ë: ' + (item.nutri.prot > 0 ? item.nutri.prot.toFixed(1) : 0) + '</span>' +
          '<span>–ñ: ' + (item.nutri.fat > 0 ? item.nutri.fat.toFixed(1) : 0) + '</span>' +
          '<span>–£: ' + (item.nutri.carb > 0 ? item.nutri.carb.toFixed(1) : 0) + '</span>' +
        '</div>' : '';

      html += '<div class="dish-card">' +
        '<div class="dish-category">' + item.category + '</div>' +
        '<div class="dish-name">' + item.name + '</div>' +
        (item.price ? '<div class="dish-price">' + item.price + ' ‚ÇΩ</div>' : '') +
        (item.weight ? '<div class="dish-meta">–í–µ—Å: ' + item.weight + '</div>' : '') +
        (item.composition ? '<div class="dish-composition">' + item.composition + '</div>' : '') +
        nutritionHtml +
        '<div class="dish-tags">' + tagsHtml + '</div>' +
        '<button class="add-btn" id="btn-' + item.id + '" onclick="window.edaAddToDiary(' + item.id + ')">+ –°—ä–µ–ª</button>' +
      '</div>';
    }
    container.innerHTML = html;
  }

  // === –ë–£–§–ï–¢ ===
  function addBuffetToDiary(name, nutrition, el) {
    var item = {
      id: buffetItemCounter++,
      name: name,
      category: '–ë—É—Ñ–µ—Ç',
      type: '–ë—É—Ñ–µ—Ç',
      weight: '1 –ø–æ—Ä—Ü–∏—è',
      nutri: { kcal: nutrition[0], prot: nutrition[1], fat: nutrition[2], carb: nutrition[3] },
      tags: { protein: nutrition[1] > 20, fiber: false, lactose: false, gf: false, vegan: false },
      allergies: '',
      source: 'buffet'
    };
    
    dailyLog.push(item);
    saveDiary();
    updateDiaryUI();
    
    var pan = document.getElementById('diary-panel');
    if (pan) pan.style.display = 'flex';
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è injectBuffet
  function findProductCard(element) {
    return element.closest('.t-store__card');
  }
  
  function isBuffetProduct(card) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É —Ç–∞–±—É
    var activeTab = document.querySelector('[role="tab"][aria-selected="true"]');
    if (activeTab && (activeTab.textContent || '').toLowerCase().indexOf('–±—É—Ñ–µ—Ç') !== -1) {
      return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—è—Ö
    var element = card;
    for (var i = 0; i < 10 && element; i++) {
      var text = (element.textContent || '').toLowerCase();
      if (text.indexOf('–±—É—Ñ–µ—Ç') !== -1 || text.indexOf('–±–∏–∑–Ω–µ—Å-–∑–∞–≤—Ç—Ä–∞–∫') !== -1) {
        return true;
      }
      element = element.parentElement;
    }
    return false;
  }
  
  function findProductNameElement(titleEl, card) {
    if (titleEl.classList && titleEl.classList.contains('t-store__card__title')) {
      return titleEl;
    }
    return card.querySelector('.t-store__card__title');
  }
  
  function insertAfterElement(element, newElement) {
    if (element && element.parentElement) {
      try {
        element.insertAdjacentElement('afterend', newElement);
      } catch(e) {
        var parent = element.parentElement;
        var nextSibling = element.nextSibling;
        if (nextSibling) {
          parent.insertBefore(newElement, nextSibling);
        } else {
          parent.appendChild(newElement);
        }
      }
    }
  }
  
  function findButtonsContainer(card) {
    return card.querySelector('.t-store__card__btns-wrapper');
  }
  
  function setupCartNameFix(productNameEl, originalName, originalHTML) {
    if (!productNameEl || !originalName) return;
    
    var cartButtons = productNameEl.closest('.t-store__card')?.querySelectorAll('.t-store__card__btn');
    if (!cartButtons || cartButtons.length === 0) return;
    
    cartButtons.forEach(function(cartBtn) {
      cartBtn.addEventListener('click', function(e) {
        var currentContent = productNameEl.innerHTML;
        productNameEl.textContent = originalName;
        setTimeout(function() {
          productNameEl.innerHTML = originalHTML || currentContent;
        }, 150);
      }, true);
    });
  }

  function injectBuffet() {
    var titleElements = document.querySelectorAll('.t-store__card__title');
    
    titleElements.forEach(function(titleEl) {
      var card = findProductCard(titleEl);
      if (!card) return;
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –∏–ª–∏ –Ω–µ –±—É—Ñ–µ—Ç
      if (card.getAttribute('data-eda-buffet-done') || card.querySelector('.eda-buffet-kbju')) return;
      if (!isBuffetProduct(card)) return;
      
      card.setAttribute('data-eda-buffet-done', '1');
      
      var name = (titleEl.textContent || '').trim();
      if (!name || name.length < 2) return;
      
      var nutrition = getBuffetNutrition(titleEl);
      if (!nutrition || !nutrition[0]) return;
      
      // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
      var productNameEl = findProductNameElement(titleEl, card);
      var originalName = null;
      var originalHTML = null;
      
      if (productNameEl) {
        originalName = productNameEl.textContent.trim();
        originalHTML = productNameEl.innerHTML;
        productNameEl.setAttribute('data-original-name', originalName);
        productNameEl.setAttribute('data-original-html', originalHTML);
      }
      
      // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –ö–ë–ñ–£
      var kbjuBlock = document.createElement('div');
      kbjuBlock.className = 'eda-buffet-kbju';
      kbjuBlock.setAttribute('data-eda-kbju-block', 'true');
      kbjuBlock.innerHTML = '<span>' + nutrition[0] + ' –∫–∫–∞–ª ¬∑ –ë ' + nutrition[1] + ' ¬∑ –ñ ' + nutrition[2] + ' ¬∑ –£ ' + nutrition[3] + '</span>';
      
      // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "+ –°—ä–µ–ª"
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'eda-buffet-syel';
      btn.setAttribute('data-eda-kbju-block', 'true');
      btn.textContent = '+ –°—ä–µ–ª';
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        addBuffetToDiary(name, nutrition, titleEl);
        var orig = btn.textContent;
        btn.textContent = '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ';
        btn.classList.add('done');
        setTimeout(function() {
          btn.textContent = orig;
          btn.classList.remove('done');
        }, 1000);
        return false;
      };
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫ –ö–ë–ñ–£ –ø–æ—Å–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
      if (productNameEl) {
        insertAfterElement(productNameEl, kbjuBlock);
      } else {
        var textWrapper = card.querySelector('.t-store__card__textwrapper');
        (textWrapper || card).appendChild(kbjuBlock);
      }
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫
      var buttonsWrapper = findButtonsContainer(card);
      
      if (buttonsWrapper) {
        buttonsWrapper.appendChild(btn);
      } else {
        // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –∫–Ω–æ–ø–∫—É "–í –∫–æ—Ä–∑–∏–Ω—É" –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –µ–µ —Ä–æ–¥–∏—Ç–µ–ª—è
        var cartButton = card.querySelector('.t-store__card__btn');
        if (cartButton && cartButton.parentElement) {
          cartButton.parentElement.appendChild(btn);
        } else {
          kbjuBlock.appendChild(btn);
        }
      }
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
      setupCartNameFix(productNameEl, originalName, originalHTML);
    });
  }

  // === –°–û–ó–î–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ ===
  function createStructure() {
    if (document.getElementById('menu-app')) return;
    
    // –ò—â–µ–º tabpanel "–°—Ç–æ–ª–æ–≤–∞—è" –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    var targetPanel = null;
    var tabpanels = document.querySelectorAll('[role="tabpanel"]');
    
    // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ aria-labelledby - —ç—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±
    var tabs = document.querySelectorAll('[role="tablist"] [role="tab"]');
    for (var i = 0; i < tabs.length; i++) {
      var tabText = (tabs[i].textContent || '').trim();
      if (tabText.indexOf('–°—Ç–æ–ª–æ–≤–∞—è') !== -1) {
        var tabId = tabs[i].id;
        if (tabId) {
          // –ò—â–µ–º tabpanel —Å aria-labelledby, —É–∫–∞–∑—ã–≤–∞—é—â–∏–º –Ω–∞ —ç—Ç–æ—Ç —Ç–∞–±
          for (var j = 0; j < tabpanels.length; j++) {
            if (tabpanels[j].getAttribute('aria-labelledby') === tabId) {
              targetPanel = tabpanels[j];
              break;
            }
          }
        }
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ aria-labelledby, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—è–¥–æ–∫ (–ø–µ—Ä–≤—ã–π —Ç–∞–± = –ø–µ—Ä–≤—ã–π tabpanel)
        if (!targetPanel && i < tabpanels.length) {
          targetPanel = tabpanels[i];
        }
        break;
      }
    }
    
    var body = document.body;
    if (!body) return;
    
    var menuApp = document.createElement('div');
    menuApp.id = 'menu-app';
    menuApp.innerHTML = 
      '<div class="menu-header">' +
        '<h2 id="current-date-title">–ú–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>' +
        '<div class="current-info" id="cycle-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>' +
      '</div>' +
      '<div class="menu-controls">' +
        '<div class="meal-tabs">' +
          '<button class="meal-tab active" onclick="window.edaSetMealType(\'–ó–∞–≤—Ç—Ä–∞–∫\')">–ó–∞–≤—Ç—Ä–∞–∫</button>' +
          '<button class="meal-tab" onclick="window.edaSetMealType(\'–û–±–µ–¥\')">–û–±–µ–¥</button>' +
        '</div>' +
        '<div class="filters-row" id="category-filters"></div>' +
        '<div class="filters-row">' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleFilter(\'vegan\')"> –í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ</label>' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleFilter(\'gf\')"> –ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞</label>' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleFilter(\'lactose\')"> –ë–µ–∑ –ª–∞–∫—Ç–æ–∑—ã</label>' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleFilter(\'protein\')"> –ú–Ω–æ–≥–æ –±–µ–ª–∫–∞</label>' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleFilter(\'fiber\')"> –ú–Ω–æ–≥–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏</label>' +
          '<label class="filter-label"><input type="checkbox" onchange="window.edaToggleHarvard()"> –ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∞—è —Ç–∞—Ä–µ–ª–∫–∞</label>' +
        '</div>' +
      '</div>' +
      '<div id="menu-container" class="menu-grid">' +
        '<div style="text-align:center; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>' +
      '</div>';
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ tabpanel –µ—Å–ª–∏ –Ω–∞—à–ª–∏, –∏–Ω–∞—á–µ –≤ body
    if (targetPanel) {
      targetPanel.appendChild(menuApp);
    } else {
      body.insertBefore(menuApp, body.firstChild);
    }
    
    if (!document.getElementById('diary-panel')) {
      var diary = document.createElement('div');
      diary.id = 'diary-panel';
      diary.className = 'nutrition-diary';
      diary.style.display = 'none';
      diary.style.fontFamily = "'Croc', sans-serif";
      diary.innerHTML = 
        '<div class="diary-content">' +
          '<div class="diary-stats">' +
            '<div class="stat-item"><span class="stat-val" id="total-kcal">0</span><span class="stat-label">–ö–∫–∞–ª</span></div>' +
            '<div class="stat-item"><span class="stat-val" id="total-prot">0</span><span class="stat-label">–ë–µ–ª–∫–∏</span></div>' +
            '<div class="stat-item"><span class="stat-val" id="total-fat">0</span><span class="stat-label">–ñ–∏—Ä—ã</span></div>' +
            '<div class="stat-item"><span class="stat-val" id="total-carb">0</span><span class="stat-label">–£–≥–ª–µ–≤–æ–¥—ã</span></div>' +
          '</div>' +
          '<div class="diary-user">' +
            '<button class="diary-list-btn" onclick="window.edaOpenDiaryList()">–°–ø–∏—Å–æ–∫ –±–ª—é–¥</button>' +
            '<button class="reset-btn" onclick="window.edaResetDiary()">–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–Ω—å</button>' +
          '</div>' +
        '</div>';
      body.appendChild(diary);
    }
    
    if (!document.getElementById('diary-modal')) {
      var modal = document.createElement('div');
      modal.id = 'diary-modal';
      modal.className = 'diary-modal';
      modal.innerHTML = 
        '<div class="diary-modal-content">' +
          '<div class="diary-modal-header">' +
            '<h3 class="diary-modal-title">–°–ø–∏—Å–æ–∫ –±–ª—é–¥</h3>' +
            '<button class="diary-modal-close" onclick="window.edaCloseDiaryList()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>' +
          '</div>' +
          '<div class="diary-modal-body" id="diary-list-body"></div>' +
        '</div>';
      body.appendChild(modal);
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –î–û –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  window.edaAddToDiary = addToDiary;
  window.edaSetMealType = setMealType;
  window.edaToggleFilter = toggleFilter;
  window.edaToggleCategory = toggleCategory;
  window.edaToggleHarvard = toggleHarvard;
  window.edaResetDiary = resetDiary;
  window.edaOpenDiaryList = openDiaryList;
  window.edaCloseDiaryList = closeDiaryList;
  window.edaRemoveFromDiary = removeFromDiary;

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  function init() {
    // –ñ–¥–µ–º, –ø–æ–∫–∞ Tilda –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏ —Ç–∞–±—ã –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã
    var attempts = 0;
    var maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
    
    function tryInit() {
      attempts++;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–æ–≤ Tilda
      var hasTildaTabs = document.querySelectorAll('[role="tablist"]').length > 0;
      
      if (hasTildaTabs || attempts >= maxAttempts) {
        createStructure();
        startDataLoading();
      } else {
        setTimeout(tryInit, 100);
      }
    }
    
    function startDataLoading() {
      if (typeof Papa !== 'undefined') {
      Papa.parse(GOOGLE_SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          allMenuData = results.data
            .filter(function(row) { return row['–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'] && row['–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'].trim(); })
            .map(function(row, idx) {
              var check = function(key) {
                return row[key] && (row[key].toUpperCase() === 'TRUE' || row[key] === '1');
              };
              return {
                id: idx,
                week: parseInt(row['–ù–µ–¥–µ–ª—è']) || 0,
                day: row['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] ? row['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'].trim() : '',
                type: row['–ü—Ä–∏–µ–º –ø–∏—â–∏'] ? row['–ü—Ä–∏–µ–º –ø–∏—â–∏'].trim() : '',
                category: row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '',
                name: row['–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'] ? row['–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'].trim() : '',
                weight: row['–í–µ—Å'] || '',
                price: row['–¶–µ–Ω–∞'] ? row['–¶–µ–Ω–∞'].trim() : '',
                composition: row['–°–æ—Å—Ç–∞–≤'] ? row['–°–æ—Å—Ç–∞–≤'].trim() : '',
                nutri: {
                  kcal: parseFloat((row['–ö–∫–∞–ª'] || '0').replace(',', '.')) || 0,
                  prot: parseFloat((row['–ë–µ–ª–∫–∏'] || '0').replace(',', '.')) || 0,
                  fat: parseFloat((row['–ñ–∏—Ä—ã'] || '0').replace(',', '.')) || 0,
                  carb: parseFloat((row['–£–≥–ª–µ–≤–æ–¥—ã'] || '0').replace(',', '.')) || 0
                },
                tags: {
                  protein: check('–ë–µ–ª–æ–∫'),
                  fiber: check('–ö–ª–µ—Ç—á–∞—Ç–∫–∞'),
                  lactose: check('–ë–µ–∑ –ª–∞–∫—Ç–æ–∑—ã'),
                  gf: check('–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞'),
                  vegan: check('–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ')
                },
                allergies: row['–ê–ª–ª–µ—Ä–≥–µ–Ω'] ? row['–ê–ª–ª–µ—Ä–≥–µ–Ω'].trim() : '',
                otShefa: check('–û—Ç –®–µ—Ñ–∞'),
                stantsiya: check('–°—Ç–∞–Ω—Ü–∏—è'),
                harvardPlate: row['–ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∞—è —Ç–∞—Ä–µ–ª–∫–∞'] ? row['–ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∞—è —Ç–∞—Ä–µ–ª–∫–∞'].trim() : ''
              };
            });
          
          if (currentMealType !== '–ó–∞–≤—Ç—Ä–∞–∫' && currentMealType !== '–û–±–µ–¥') {
            currentMealType = '–ó–∞–≤—Ç—Ä–∞–∫';
          }
          
          loadDiary();
          updateCategoryFilters();
          renderMenu();
          updateDiaryUI();
        }
      });
    }
    
      loadTildaAPI().then(function() {
        injectBuffet();
        setTimeout(injectBuffet, 300);
      });
      
      injectBuffet();
      setTimeout(injectBuffet, 800);
      setTimeout(injectBuffet, 2000);
      
      var lastInject = 0;
      var mo = typeof MutationObserver !== 'undefined' ? new MutationObserver(function() {
        var now = Date.now();
        if (now - lastInject < 400) return;
        lastInject = now;
        setTimeout(injectBuffet, 300);
      }) : null;
      if (mo && document.body) mo.observe(document.body, { childList: true, subtree: true });
      
      document.addEventListener('click', function(e) {
        if ((e.target.textContent || '').indexOf('–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ') !== -1) {
          setTimeout(injectBuffet, 1500);
        }
        var modal = document.getElementById('diary-modal');
        if (e.target === modal) {
          closeDiaryList();
        }
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          var modal = document.getElementById('diary-modal');
          if (modal && modal.classList.contains('active')) {
            closeDiaryList();
          }
        }
      });
      
      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ Tilda —á–µ—Ä–µ–∑ MutationObserver
      var tablist = document.querySelector('[role="tablist"]');
      if (tablist) {
        // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ aria-selected –≤ —Ç–∞–±–∞—Ö
        var tabObserver = new MutationObserver(function(mutations) {
          var menuApp = document.getElementById('menu-app');
          var activeTab = document.querySelector('[role="tab"][aria-selected="true"]');
          
          if (!activeTab) return;
          
          var activeTabText = (activeTab.textContent || '').trim();
          
          // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —Ç–∞–± "–ë—É—Ñ–µ—Ç", –≤—ã–∑—ã–≤–∞–µ–º injectBuffet
          if (activeTabText.indexOf('–ë—É—Ñ–µ—Ç') !== -1) {
            setTimeout(function() {
              injectBuffet();
              setTimeout(injectBuffet, 300);
              setTimeout(injectBuffet, 800);
            }, 100);
          }
          
          // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —Ç–∞–± "–°—Ç–æ–ª–æ–≤–∞—è", –ø—Ä–æ–≤–µ—Ä—è–µ–º tabpanel
          if (activeTabText.indexOf('–°—Ç–æ–ª–æ–≤–∞—è') !== -1 && menuApp) {
            var tabId = activeTab.id;
            var correctPanel = null;
            
            if (tabId) {
              var panels = document.querySelectorAll('[role="tabpanel"]');
              for (var p = 0; p < panels.length; p++) {
                if (panels[p].getAttribute('aria-labelledby') === tabId) {
                  correctPanel = panels[p];
                  break;
                }
              }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ aria-labelledby, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—è–¥–æ–∫
            if (!correctPanel) {
              var tabs = tablist.querySelectorAll('[role="tab"]');
              var tabIndex = Array.prototype.indexOf.call(tabs, activeTab);
              var panels = document.querySelectorAll('[role="tabpanel"]');
              if (tabIndex >= 0 && tabIndex < panels.length) {
                correctPanel = panels[tabIndex];
              }
            }
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π tabpanel, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Ç–∞–º
            if (correctPanel && !correctPanel.contains(menuApp)) {
              correctPanel.appendChild(menuApp);
            }
          }
        });
        
        // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ç–∞–±–∞—Ö
        var tabs = tablist.querySelectorAll('[role="tab"]');
        for (var k = 0; k < tabs.length; k++) {
          tabObserver.observe(tabs[k], { attributes: true, attributeFilter: ['aria-selected'] });
        }
        
        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Ç–∞–±—ã –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ injectBuffet
        for (var m = 0; m < tabs.length; m++) {
          tabs[m].addEventListener('click', function() {
            var clickedTab = this;
            setTimeout(function() {
              var tabText = (clickedTab.textContent || '').trim();
              if (tabText.indexOf('–ë—É—Ñ–µ—Ç') !== -1) {
                injectBuffet();
                setTimeout(injectBuffet, 500);
                setTimeout(injectBuffet, 1500);
              }
            }, 200);
          });
        }
      }
    }
    
    tryInit();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    setTimeout(init, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è Tilda
  }
})();
</script>
