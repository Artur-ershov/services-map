# КРОК СЕРВИСЫ - Модуль карты этажей

## Контекст проекта

Этот проект представляет собой интерактивный модуль карты этажей зданий для отображения сервисов и помещений. Модуль разрабатывается для интеграции в **Tilda** (конструктор сайтов).

## Важные заметки

### Временный фикс для шрифтов

**ВАЖНО: Файл `tmp.css` НЕ УДАЛЯТЬ!**

Файл `tmp.css` содержит временный фикс для подключения шрифтов:
- Использует `!important` для переопределения `font-family` на всех элементах
- Подключает локальный шрифт из `assets/fonts/CoFoWeather20240219-VF.ttf` для локального просмотра
- Это необходимо для корректной работы шрифтов в контексте Tilda
- В Tilda шрифт будет задан отдельно, но для локальной разработки нужен `tmp.css`
- **НЕ УДАЛЯТЬ** - используется для локального просмотра с правильным шрифтом

### Структура проекта

```
srv/
├── index.html, app.js, style.css, tmp.css, data.js  # Основные файлы
├── map/          # SVG карты этажей
├── scripts/      # Скрипты автоматизации
├── data/         # CSV источник данных
├── assets/       # Ресурсы (шрифты)
│   └── fonts/
└── docs/         # Документация
```

Подробнее: [`docs/FILE_STRUCTURE.md`](docs/FILE_STRUCTURE.md)

### CSS переменные

Модуль использует CSS переменные для корпоративных цветов:
- `--krok-green`, `--krok-blue`, `--krok-purple`, `--krok-red`, `--krok-orange`
- RGB версии для использования в `rgba()`: `--krok-*-rgb`

## Запуск локального сервера

Для разработки и тестирования модуля используется команда `srv`:

```bash
srv
```

Сервер запустится на `http://localhost/` (порт 80) с автоматической перезагрузкой страницы при изменении файлов (livereload).

**Важно:** При использовании livereload временно отключены debug-логи с `fetch()` запросами, чтобы избежать постоянных перезагрузок страницы.

## Интеграция в Tilda

При интеграции в Tilda необходимо:
1. Убедиться, что все CSS файлы загружаются в правильном порядке
2. Проверить, что шрифты доступны (или использовать `tmp.css`)
3. Убедиться, что модуль изолирован от стилей Tilda (используется `#krok-services-map-module`)

## Документация

### Публичная документация

- [`docs/PROCESS.md`](docs/PROCESS.md) - процесс работы с проектом и чеклист
- [`docs/SVG_PROCESSING.md`](docs/SVG_PROCESSING.md) - правила обработки SVG и решение проблемы "черных квадратов"
- [`docs/FILE_STRUCTURE.md`](docs/FILE_STRUCTURE.md) - структура файлов и система документации

### Внутренняя документация (для AI контекста)

- `.cursor/ARCHITECTURE_DISCUSSIONS.md` - архитектурные обсуждения и решения
- `.cursor/WORKFLOW_NOTES.md` - заметки о процессе работы

**Примечание:** Файлы в `.cursor/` не коммитятся в Git и используются для восстановления контекста работы с AI.

## Синхронизация данных

Для обновления данных из Google Sheets (по умолчанию):

```bash
python scripts/sync-csv-to-data.py
```Или укажите URL Google Sheets напрямую:

```bash
python scripts/sync-csv-to-data.py https://docs.google.com/spreadsheets/d/e/.../pub?output=csv
```

Или используйте локальный CSV файл:

```bash
python scripts/sync-csv-to-data.py data/table.csv
```

**Примечание:** Скрипт автоматически использует Google Sheets URL по умолчанию, если не указан другой источник.

**Важно:** Колонка `id` в CSV должна совпадать с `id` групп в SVG файлах (`map/*.svg`).

## Синхронизация файлов Tilda

Для получения файлов Tilda локально и автоматической синхронизации при изменениях:

1. **Настройте API ключи:**
   ```bash
   cp .env.example .env
   # Отредактируйте .env и добавьте ваши TILDA_PUBLIC_KEY и TILDA_SECRET_KEY
   ```

2. **Установите зависимости:**
   ```bash
   npm install
   ```

3. **Запустите первоначальную синхронизацию:**
   ```bash
   node scripts/download-tilda-files.js
   ```

4. **Настройте автоматическую синхронизацию через webhook:**
   ```bash
   # Запустите webhook сервер
   node scripts/tilda-webhook-server.js
   
   # Для локальной разработки используйте ngrok:
   ngrok http 3000
   # Укажите полученный URL в Tilda: Настройки сайта → Экспорт → API → Webhook URL
   ```

Подробнее: [`docs/TILDA_DOWNLOAD.md`](docs/TILDA_DOWNLOAD.md)
